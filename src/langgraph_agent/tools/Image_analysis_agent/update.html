<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Property Review - Human Verification</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .field-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #f9f9f9;
      }
      .field-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .field-name {
        font-weight: bold;
        font-size: 16px;
      }
      .field-value {
        background: white;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
        margin: 5px 0;
      }
      .images-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 10px 0;
      }
      .image-item {
        max-width: 200px;
        border: 1px solid #ddd;
        border-radius: 5px;
        overflow: hidden;
      }
      .image-item img {
        width: 100%;
        height: 150px;
        object-fit: cover;
      }
      .update-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 3px;
        cursor: pointer;
      }
      .update-btn:hover {
        background: #0056b3;
      }
      .finish-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 5px;
        cursor: pointer;
        margin: 20px 0;
      }
      .finish-btn:hover {
        background: #218838;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 3px;
      }
      .status.updated {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Property Review - Human Verification</h1>
      <p>
        Please review each field against the provided images and update if
        necessary.
      </p>

      <div id="fieldsContainer">
        <!-- Fields will be populated by JavaScript -->
      </div>

      <button class="finish-btn" onclick="finishReview()">
        Finish Review & Save Changes
      </button>

      <div id="statusMessage"></div>
    </div>

    <script>
      // Get data from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const propertyData = JSON.parse(urlParams.get("data") || "{}");
      const imageAnalysis = JSON.parse(urlParams.get("analysis") || "{}");

      let updatedFields = {};

      // Initialize the review page
      function initReview() {
        const fieldsContainer = document.getElementById("fieldsContainer");

        // Define the fields to review
        const fields = [
          "Roof Type",
          "Exterior Material",
          "Pool",
          "Garage",
          "Number of Stories",
          "General Condition / Renovation Indicators",
          "Lot Size / Backyard Area",
          "Driveway Type / Paved Area",
          "Solar Panels / External Installations",
        ];

        fields.forEach((field) => {
          const fieldSection = document.createElement("div");
          fieldSection.className = "field-section";
          fieldSection.id = `field-${field.replace(/\s+/g, "-")}`;

          const currentValue = imageAnalysis[field] || "Unknown";

          fieldSection.innerHTML = `
                    <div class="field-header">
                        <div class="field-name">${field}</div>
                        <button class="update-btn" onclick="updateField('${field}')">Update</button>
                    </div>
                    <div class="field-value" id="value-${field.replace(
                      /\s+/g,
                      "-"
                    )}">${currentValue}</div>
                    <div class="images-container" id="images-${field.replace(
                      /\s+/g,
                      "-"
                    )}">
                        <!-- Images will be loaded here -->
                    </div>
                    <div class="status pending" id="status-${field.replace(
                      /\s+/g,
                      "-"
                    )}">Pending Review</div>
                `;

          fieldsContainer.appendChild(fieldSection);

          // Load images for this field
          loadImagesForField(field);
        });
      }

      // Load images for a specific field
      function loadImagesForField(field) {
        const imagesContainer = document.getElementById(
          `images-${field.replace(/\s+/g, "-")}`
        );
        const images = propertyData.images || [];

        images.forEach((imageUrl, index) => {
          const imageItem = document.createElement("div");
          imageItem.className = "image-item";
          imageItem.innerHTML = `
                    <img src="${imageUrl}" alt="Property Image ${index + 1}" 
                         onclick="openImageModal('${imageUrl}')">
                `;
          imagesContainer.appendChild(imageItem);
        });
      }

      // Update a field value
      function updateField(fieldName) {
        const newValue = prompt(
          `Enter new value for ${fieldName}:`,
          imageAnalysis[fieldName] || "Unknown"
        );

        if (newValue !== null) {
          // Update the display
          document.getElementById(
            `value-${fieldName.replace(/\s+/g, "-")}`
          ).textContent = newValue;

          // Update the status
          const statusEl = document.getElementById(
            `status-${fieldName.replace(/\s+/g, "-")}`
          );
          statusEl.textContent = "Updated";
          statusEl.className = "status updated";

          // Store the updated value
          updatedFields[fieldName] = newValue;
        }
      }

      // Open image in modal (simple implementation)
      function openImageModal(imageUrl) {
        window.open(imageUrl, "_blank");
      }

      // Finish review and save changes
      function finishReview() {
        if (Object.keys(updatedFields).length === 0) {
          alert(
            "No changes made. Please update at least one field or close this window."
          );
          return;
        }

        // Send updated data back to parent window
        if (window.opener) {
          window.opener.postMessage(
            {
              type: "review_complete",
              updatedFields: updatedFields,
              propertyData: propertyData,
            },
            "*"
          );
        }

        // Show success message
        document.getElementById("statusMessage").innerHTML = `
                <div class="status updated">
                    âœ… Review completed! ${
                      Object.keys(updatedFields).length
                    } fields updated. 
                    Changes have been sent to the main application.
                </div>
            `;

        // Close window after 2 seconds
        setTimeout(() => {
          window.close();
        }, 2000);
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", initReview);
    </script>
  </body>
</html>
